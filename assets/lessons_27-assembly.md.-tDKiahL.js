import{_ as i,o as e,c as a,ae as t}from"./chunks/framework.CfVLvsAT.js";const c=JSON.parse('{"title":"Chapter 27: Grand Assembly","description":"","frontmatter":{},"headers":[],"relativePath":"lessons/27-assembly.md","filePath":"lessons/27-assembly.md"}'),n={name:"lessons/27-assembly.md"};function l(o,s,h,r,p,d){return e(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="chapter-27-grand-assembly" tabindex="-1">Chapter 27: Grand Assembly <a class="header-anchor" href="#chapter-27-grand-assembly" aria-label="Permalink to &quot;Chapter 27: Grand Assembly&quot;">â€‹</a></h1><p>You have bricks, wood, and glass. Now let&#39;s build the house. In this final chapter, we look at <code>cmd/api/main.go</code>. This is where all the isolated pieces we learned about (Router, Config, Database) are wired together.</p><h2 id="_27-1-standard-project-layout" tabindex="-1">27.1 Standard Project Layout <a class="header-anchor" href="#_27-1-standard-project-layout" aria-label="Permalink to &quot;27.1 Standard Project Layout&quot;">â€‹</a></h2><p>Why isn&#39;t everything in the root folder? Professional Go projects often use the <strong>Standard Go Project Layout</strong>:</p><ol><li><strong><code>cmd/</code></strong>: The Main Applications. <ul><li><code>cmd/api/main.go</code>: The entry point for our API.</li><li><code>cmd/cli/main.go</code>: (Optional) CLI tools.</li><li><em>Rule</em>: No logic here. Just wiring.</li></ul></li><li><strong><code>internal/</code></strong>: The Library Code. <ul><li><code>internal/models</code>: Data Structures.</li><li><code>internal/store</code>: Database Logic.</li><li><em>Rule</em>: Code here allows our app to work, but other people can&#39;t import it (Go enforces this privacy).</li></ul></li></ol><h2 id="_27-2-the-main-wiring" tabindex="-1">27.2 The Main Wiring <a class="header-anchor" href="#_27-2-the-main-wiring" aria-label="Permalink to &quot;27.2 The Main Wiring&quot;">â€‹</a></h2><p>Open <code>cmd/api/main.go</code>. Let&#39;s read it like a schematic.</p><h3 id="step-1-power-on-configuration" tabindex="-1">Step 1: Power On (Configuration) <a class="header-anchor" href="#step-1-power-on-configuration" aria-label="Permalink to &quot;Step 1: Power On (Configuration)&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cfg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> config.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><ul><li><strong>Why?</strong>: Before doing anything, we need to know <em>how</em> to run (Port, DB Password).</li><li><strong>Chapter</strong>: 9 (Configuration).</li></ul><h3 id="step-2-unlock-the-warehouse-database" tabindex="-1">Step 2: Unlock the Warehouse (Database) <a class="header-anchor" href="#step-2-unlock-the-warehouse-database" aria-label="Permalink to &quot;Step 2: Unlock the Warehouse (Database)&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">db, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sql.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Open</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;postgres&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cfg.DB.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DSN</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span></code></pre></div><ul><li><strong>Why?</strong>: We establish the connection pool. We don&#39;t query yet; we just prepare the line.</li><li><strong>Chapter</strong>: 13 (Postgres).</li></ul><h3 id="step-3-hire-the-staff-dependency-injection" tabindex="-1">Step 3: Hire the Staff (Dependency Injection) <a class="header-anchor" href="#step-3-hire-the-staff-dependency-injection" aria-label="Permalink to &quot;Step 3: Hire the Staff (Dependency Injection)&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">var</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bookStore </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">store</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BookRepository</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> store.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">NewPostgresBookStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(db)</span></span></code></pre></div><ul><li><strong>Why?</strong>: We create the <code>bookStore</code> worker and <strong>give</strong> it the database connection (<code>db</code>).</li><li><strong>Concept</strong>: Dependency Injection (Chapter 12).</li></ul><h3 id="step-4-security-checkpoints-middleware" tabindex="-1">Step 4: Security Checkpoints (Middleware) <a class="header-anchor" href="#step-4-security-checkpoints-middleware" aria-label="Permalink to &quot;Step 4: Security Checkpoints (Middleware)&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">server </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Server</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Handler: middleware.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Recoverer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(middleware.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Logger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mux)),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><strong>Why?</strong>: We wrap the router (<code>mux</code>) in our &quot;Onion Layers&quot;. <ol><li>Request hits <code>Recoverer</code> (Safety Net).</li><li>Hits <code>Logger</code> (Record keeping).</li><li>Hits <code>mux</code> (The Router).</li></ol></li><li><strong>Chapter</strong>: 14 (Middleware).</li></ul><h3 id="step-5-open-for-business" tabindex="-1">Step 5: Open for Business <a class="header-anchor" href="#step-5-open-for-business" aria-label="Permalink to &quot;Step 5: Open for Business&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">server.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ListenAndServe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><ul><li><strong>Why?</strong>: This starts the infinite loop that listens for traffic on the port.</li><li><strong>Chapter</strong>: 7 (Web Server).</li></ul><h2 id="_27-3-graceful-shutdown-dying-with-dignity" tabindex="-1">27.3 Graceful Shutdown (Dying with Dignity) <a class="header-anchor" href="#_27-3-graceful-shutdown-dying-with-dignity" aria-label="Permalink to &quot;27.3 Graceful Shutdown (Dying with Dignity)&quot;">â€‹</a></h2><p>In production, servers restart often. You don&#39;t want to kill active users mid-request. We catch OS signals (<code>SIGINT</code>, <code>SIGTERM</code>) and give the server a standardized timeout (e.g., 5 seconds) to finish current jobs before quitting.</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Wait for Ctrl+C</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">quit </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> make</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">chan</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> os</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Signal</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">signal.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Notify</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(quit, syscall.SIGINT, syscall.SIGTERM)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">quit</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Give 5 seconds to finish</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.Second)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">srv.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Shutdown</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span></code></pre></div><h2 id="_27-4-you-did-it" tabindex="-1">27.4 You Did It! <a class="header-anchor" href="#_27-4-you-did-it" aria-label="Permalink to &quot;27.4 You Did It!&quot;">â€‹</a></h2><p>You have built a modular, professional-grade REST API.</p><h2 id="the-checklist" tabindex="-1">The Checklist <a class="header-anchor" href="#the-checklist" aria-label="Permalink to &quot;The Checklist&quot;">â€‹</a></h2><ul><li>[ ] <strong>Data</strong>: <code>struct</code> with JSON tags? (Ch 8)</li><li>[ ] <strong>Logic</strong>: Handlers inject a Repository? (Ch 12)</li><li>[ ] <strong>Safety</strong>: Unit Tests passed? (Ch 15)</li><li>[ ] <strong>Deployment</strong>: CI/CD pipeline green? (Ch 16)</li></ul><p>If you can say <strong>YES</strong> to all these, you are no longer a Junior. <strong>Welcome to the Professional Tier.</strong></p><details class="details custom-block"><summary>ðŸŽ“ Knowledge Check: Why shouldn&#39;t we put business logic in <code>cmd/api/main.go</code>?</summary><p><strong>Answer</strong>: Separation of Concerns. <code>cmd/</code> is only for <strong>wiring</strong> (starting the engine). Logic belongs in <code>internal/</code> so it can be tested in isolation and reused.</p></details>`,31)])])}const g=i(n,[["render",l]]);export{c as __pageData,g as default};

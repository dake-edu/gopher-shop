import{_ as i,o as a,c as e,ae as n}from"./chunks/framework.CfVLvsAT.js";const g=JSON.parse('{"title":"14. The Onion (Middleware)","description":"","frontmatter":{},"headers":[],"relativePath":"middleware.md","filePath":"middleware.md"}'),t={name:"middleware.md"};function l(h,s,r,o,p,d){return a(),e("div",null,[...s[0]||(s[0]=[n(`<h1 id="_14-the-onion-middleware" tabindex="-1">14. The Onion (Middleware) <a class="header-anchor" href="#_14-the-onion-middleware" aria-label="Permalink to &quot;14. The Onion (Middleware)&quot;">â€‹</a></h1><p>This is one of the most advanced concepts in Go web servers. Let&#39;s dissect it carefully.</p><h2 id="_14-1-functions-as-values" tabindex="-1">14.1 Functions as Values <a class="header-anchor" href="#_14-1-functions-as-values" aria-label="Permalink to &quot;14.1 Functions as Values&quot;">â€‹</a></h2><p>In Go, a function is a value. You can:</p><ol><li>Store it in a variable.</li><li>Pass it as an argument.</li><li>Return it from another function.</li></ol><h2 id="_14-2-the-middleware-signature" tabindex="-1">14.2 The Middleware Signature <a class="header-anchor" href="#_14-2-the-middleware-signature" aria-label="Permalink to &quot;14.2 The Middleware Signature&quot;">â€‹</a></h2><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Logging</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HandlerFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">w</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ResponseWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Pre-Processing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Start&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        next.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ServeHTTP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(w, r) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Pass the baton</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        // Post-Processing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;End&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    })</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="line-by-line-anatomy" tabindex="-1">Line-by-Line Anatomy <a class="header-anchor" href="#line-by-line-anatomy" aria-label="Permalink to &quot;Line-by-Line Anatomy&quot;">â€‹</a></h3><ol><li><strong><code>func Logging(next http.Handler) http.Handler</code></strong>: <ul><li>Input: The <strong>Next</strong> layer of the onion (the inner handler).</li><li>Output: A <strong>New</strong> handler that wraps the old one.</li></ul></li><li><strong><code>return http.HandlerFunc(...)</code></strong>: <ul><li>We are building a new handler on the fly.</li></ul></li><li><strong><code>func(w, r)</code></strong>: <ul><li>This is the <strong>Closure</strong>. It captures the <code>next</code> variable from outside.</li></ul></li><li><strong><code>next.ServeHTTP(w, r)</code></strong>: <ul><li><strong>Crucial</strong>: This calls the original handler.</li><li>If you forget this line, the request stops here. The User never gets a response.</li></ul></li></ol><p>If <code>Transport</code> talks to <code>Service</code>, and <code>Service</code> talks to <code>Repository</code>... who checks if the user is logged in? Who measures speed? This is the <strong>Middleware</strong>.</p><h2 id="the-matryoshka-russian-doll" tabindex="-1">The Matryoshka (Russian Doll) <a class="header-anchor" href="#the-matryoshka-russian-doll" aria-label="Permalink to &quot;The Matryoshka (Russian Doll)&quot;">â€‹</a></h2><p>Middleware is like a Matryoshka doll. You put your Handler inside a Logger. You put the Logger inside an Authenticator. When a request comes in, it has to drill through all the outer layers to reach the center (your logic).</p><div class="language-mermaid vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">mermaid</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">graph LR</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Req((Request)) --&gt; Auth[Auth Layer]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Auth --&gt; Log[Log Layer]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Log --&gt; Handler[Your Function]</span></span></code></pre></div><h3 id="the-chain" tabindex="-1">The Chain <a class="header-anchor" href="#the-chain" aria-label="Permalink to &quot;The Chain&quot;">â€‹</a></h3><p>When we wrap handlers: <code>Logging(Auth(HomeHandler))</code></p><ol><li>Request arrives $\\rightarrow$ <strong>Logging</strong> starts.</li><li>Logging calls <code>next</code> $\\rightarrow$ <strong>Auth</strong> starts.</li><li>Auth calls <code>next</code> $\\rightarrow$ <strong>HomeHandler</strong> (Business Logic).</li><li>HomeHandler returns.</li><li><strong>Auth</strong> finishes.</li><li><strong>Logging</strong> finishes.</li></ol><details class="details custom-block"><summary>ðŸŽ“ Knowledge Check: What happens if a middleware forgets to call <code>next.ServeHTTP(w, r)</code>?</summary><p><strong>Answer</strong>: The request <strong>stops</strong> there! It never reaches the next middleware or your business logic. The user will likely see a blank screen or a timeout.</p></details>`,17)])])}const c=i(t,[["render",l]]);export{g as __pageData,c as default};
